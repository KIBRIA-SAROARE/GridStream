#include <iostream>
#include <vector>
#include <cmath>
#include <iomanip>
#include <string>
#include <sstream>
#include <algorithm>
#include <fstream>
#include "pmu_top.h"

using namespace std;

// ==========================================
// Helper Functions to Generate LUTs & Coeffs
// ==========================================

void generate_trig_luts(demod_t cos_lut[LUT_SIZE], demod_t sin_lut[LUT_SIZE]) {
    for (int i = 0; i < LUT_SIZE; i++) {
        data_t t = (data_t)((float)i / FS);
        cos_lut[i] = (demod_t)cos(-OMEGA_0 * (float)t);
        sin_lut[i] = (demod_t)sin(-OMEGA_0 * (float)t);
    }
}

void generate_fir_coeffs(demod_t coeffs[NUM_TAPS]) {
    // Hardcoded coefficients from et_pmu.py
    const demod_t hardcoded_coeffs[NUM_TAPS] = {
        0.0005563771f, 0.0005577445f, 0.0005610396f, 0.0005662647f, 0.0005734209f, 0.0005825082f, 0.0005935252f, 0.0006064694f, 0.0006213369f, 0.0006381227f, 
        0.0006568205f, 0.0006774229f, 0.0006999210f, 0.0007243051f, 0.0007505638f, 0.0007786849f, 0.0008086547f, 0.0008404585f, 0.0008740802f, 0.0009095028f, 
        0.0009467080f, 0.0009856761f, 0.0010263867f, 0.0010688179f, 0.0011129469f, 0.0011587496f, 0.0012062010f, 0.0012552747f, 0.0013059437f, 0.0013581796f, 
        0.0014119531f, 0.0014672337f, 0.0015239902f, 0.0015821903f, 0.0016418006f, 0.0017027869f, 0.0017651141f, 0.0018287462f, 0.0018936462f, 0.0019597764f, 
        0.0020270982f, 0.0020955722f, 0.0021651583f, 0.0022358155f, 0.0023075023f, 0.0023801761f, 0.0024537942f, 0.0025283126f, 0.0026036873f, 0.0026798733f, 
        0.0027568251f, 0.0028344968f, 0.0029128418f, 0.0029918133f, 0.0030713639f, 0.0031514456f, 0.0032320103f, 0.0033130095f, 0.0033943941f, 0.0034761151f, 
        0.0035581230f, 0.0036403681f, 0.0037228005f, 0.0038053702f, 0.0038880270f, 0.0039707205f, 0.0040534006f, 0.0041360167f, 0.0042185185f, 0.0043008555f, 
        0.0043829775f, 0.0044648342f, 0.0045463756f, 0.0046275516f, 0.0047083125f, 0.0047886088f, 0.0048683911f, 0.0049476106f, 0.0050262183f, 0.0051041661f, 
        0.0051814059f, 0.0052578901f, 0.0053335717f, 0.0054084040f, 0.0054823407f, 0.0055553364f, 0.0056273458f, 0.0056983245f, 0.0056983245f, 0.0057682287f, 
        0.0058370151f, 0.0059046412f, 0.0059710651f, 0.0060362456f, 0.0061001425f, 0.0061627161f, 0.0062239276f, 0.0062837391f, 0.0063421135f, 0.0063990145f, 
        0.0064544068f, 0.0065082561f, 0.0065605289f, 0.0066111928f, 0.0066602161f, 0.0067075686f, 0.0067532207f, 0.0067971440f, 0.0068393113f, 0.0068796962f, 
        0.0069182737f, 0.0069550198f, 0.0069899116f, 0.0070229273f, 0.0070540464f, 0.0070832495f, 0.0071105185f, 0.0071358363f, 0.0071591872f, 0.0071805565f, 
        0.0071999311f, 0.0072172989f, 0.0072326489f, 0.0072459717f, 0.0072572588f, 0.0072665034f, 0.0072736997f, 0.0072788430f, 0.0072819303f, 0.0072819303f, 
        0.0072788430f, 0.0072736997f, 0.0072665034f, 0.0072572588f, 0.0072459717f, 0.0072326489f, 0.0072172989f, 0.0071999311f, 0.0071805565f, 0.0071358363f, 
        0.0071105185f, 0.0070832495f, 0.0070540464f, 0.0070229273f, 0.0069899116f, 0.0069550198f, 0.0069182737f, 0.0068796962f, 0.0068393113f, 0.0067971440f, 
        0.0067532207f, 0.0067075686f, 0.0066602161f, 0.0066111928f, 0.0065605289f, 0.0065082561f, 0.0064544068f, 0.0063990145f, 0.0063421135f, 0.0062837391f, 
        0.0062239276f, 0.0061627161f, 0.0061001425f, 0.0060362456f, 0.0059710651f, 0.0059046412f, 0.0058370151f, 0.0057682287f, 0.0056983245f, 0.0056273458f, 
        0.0055553364f, 0.0054823407f, 0.0054084040f, 0.0053335717f, 0.0052578901f, 0.0051814059f, 0.0051041661f, 0.0050262183f, 0.0049476106f, 0.0048683911f, 
        0.0047886088f, 0.0047083125f, 0.0046275516f, 0.0045463756f, 0.0044648342f, 0.0043829775f, 0.0043008555f, 0.0042185185f, 0.0041360167f, 0.0040534006f, 
        0.0039707205f, 0.0038880270f, 0.0038053702f, 0.0037228005f, 0.0036403681f, 0.0035581230f, 0.0034761151f, 0.0033943941f, 0.0033130095f, 0.0032320103f, 
        0.0031514456f, 0.0030713639f, 0.0029918133f, 0.0029128418f, 0.0028344968f, 0.0027568251f, 0.0026798733f, 0.0026036873f, 0.0025283126f, 0.0024537942f, 
        0.0023801761f, 0.0023075023f, 0.0022358155f, 0.0021651583f, 0.0020955722f, 0.0020270982f, 0.0019597764f, 0.0018936462f, 0.0018287462f, 0.0017651141f, 
        0.0017027869f, 0.0016418006f, 0.0015821903f, 0.0015239902f, 0.0014672337f, 0.0014119531f, 0.0013581796f, 0.0013059437f, 0.0012552747f, 0.0012062010f, 
        0.0011587496f, 0.0011129469f, 0.0010688179f, 0.0010263867f, 0.0009856761f, 0.0009467080f, 0.0009095028f, 0.0008740802f, 0.0008404585f, 0.0008086547f, 
        0.0008086547f, 0.0007786849f, 0.0007505638f, 0.0007243051f, 0.0006999210f, 0.0006774229f, 0.0006568205f, 0.0006381227f, 0.0006213369f, 0.0006064694f, 
        0.0005935252f, 0.0005825082f, 0.0005734209f, 0.0005662647f, 0.0005610396f, 0.0005577445f, 0.0005563771f
    };

    for (int i = 0; i < NUM_TAPS; i++) {
        coeffs[i] = hardcoded_coeffs[i];
    }
}

// ==========================================
// Test Data
// ==========================================
// Placeholder - will be replaced by update_tb.py
const string voltage_data_str = "-1246.388182,-754.482742,-254.151144,255.289814,767.008112,1287.835770,1806.158354,2319.698524,2834.377364,3331.065218,3814.316766,4306.677674,4801.543656,5289.577618,5776.245176,6263.823670,6743.659208,7212.563514,7680.784618,8151.283062,8615.632688,9073.605762,9524.746816,9968.144914,10400.839514,10813.948990,11219.998712,11622.632424,12005.908746,12379.620240,12755.381340,13126.360026,13495.744574,13864.218186,14223.126970,14580.897084,14934.567986,15271.614306,15602.284074,15923.844482,16227.186170,16526.428646,16824.532452,17107.605814,17374.282328,17632.532684,17879.851808,18113.051424,18336.230744,18545.973758,18746.835146,18934.260228,19097.773240,19253.771030,19394.966110,19501.317888,19587.401340,19660.276220,19725.180410,19798.055290,19870.930170,19934.467956,19999.372146,20060.860326,20104.585254,20133.962940,20162.885158,20193.173780,20213.669840,20225.739742,20230.066688,20216.858116,20189.074568,20155.369936,20131.230132,20108.684466,20057.672050,19994.817466,19916.704704,19798.966226,19671.207452,19520.903012,19319.813890,19098.911910,18857.969338,18575.351444,18270.871086,17971.400876,17690.377120,17428.255286,17175.242812,16931.567432,16693.585402,16446.038544,16186.194050,15914.735122,15624.146538,15298.714652,14940.489070,14556.757280,14133.855242,13695.239558,13269.832446,12833.494102,12388.501866,11951.480320,11515.141976,11080.853238,10645.425830,10206.354678,9775.254216,9345.064690,8898.933784,8433.900956,7946.550196,7441.663918,6924.935472,6401.375006,5874.170796,5336.490822,4798.810848,4259.536736,3721.856762,3205.128316,2696.142826,2185.790932,1684.320664,1189.454682,697.321508,206.554738,-282.845628,-769.740920,-1256.863946,-1747.402982,-2232.476402,-2710.490068,-3181.671714,-3632.585034,-4073.933526,-4520.747634,-4974.621496,-5424.396146,-5870.982520,-6328.272392,-6777.363840,-7227.138490,-7655.733878,-8050.396900,-8457.129824,-8865.912354,-9279.021830,-9715.360174,-10162.629750,-10601.017700,-11038.950182,-11479.843206,-11893.180416,-12285.110630,-12664.287740,-13027.523470,-13380.055702,-13724.844978,-14059.386224,-14388.234120,-14720.953494,-15047.068582,-15366.351650,-15684.040580,-15991.253746,-16297.100508,-16607.046482,-16902.189746,-17178.203354,-17443.057996,-17690.377120,-17921.982598,-18142.656844,-18346.706508,-18541.874546,-18726.339086,-18887.574758,-19044.483484,-19187.272702,-19293.169012,-19382.896208,-19458.503896,-19520.219810,-19594.688828,-19668.702378,-19730.190558,-19797.599822,-19861.820810,-19908.734014,-19939.705838,-19965.895248,-19998.916678,-20024.422886,-20035.354118,-20039.681064,-20031.710374,-20006.431900,-19974.321406,-19952.914410,-19931.962882,-19886.188348,-19826.749774,-19753.419426,-19647.978584,-19525.913160,-19379.252464,-19187.272702,-18973.885944,-18739.319924,-18464.217252,-18166.113446,-17869.148310,-17591.312830,-17333.062474,-17084.376946,-16845.939448,-16611.601162,-16372.935930,-16123.111732,-15859.395760,-15579.966142,-15267.059626,-14920.220744,-14549.014324,-14139.093124,-13713.002810,-13303.081610,-12881.318242,-12446.346302,-12025.949338,-11609.196118,-11190.621026,-10773.412338,-10354.381778,-9944.005110,-9532.945240,-9100.933842,-8654.575202,-8195.235724,-7722.687674,-7240.802530,-6753.907238,-6264.506872,-5765.769412,-5263.160474,-4754.174984,-4244.278558,-3754.422724,-3267.755166,-2769.700908,-2273.468522,-1779.513476,-1284.647494,-788.415108,-283.301096,224.090256,732.392544,1248.665522,1761.522490,2271.874384,2782.226278,3276.636792,3761.027010,4252.021514,4748.709368,5243.575350,5731.837046,6217.593668,6700.389748,7172.254596,7640.020232,8107.102666,8568.719484,9026.920292,9475.100804,9914.627424,10349.827098,10764.530712,11171.035902,11576.857890,11961.045148,12335.667578,12711.656412,13086.506576,13456.118858,13825.047938,14194.204752,14553.796738,14907.923108,15248.613172,15573.817324,15885.812904,16180.272966,16475.643964,16772.609100,17052.494186,17327.596858,17590.401894,17824.056978,18024.235164,18202.323152,18411.155230,18572.618636,18773.480024,18961.588308,19127.834128,19330.061920,19391.322366,19564.855674,19558.023654,19702.634744,19748.181544,19105.743930,17300.268778,13901.111094,12293.536788,11329.994234,9626.543914,10928.726926,12953.737654,13189.897812,13093.110862,12944.856028,12191.056488,11658.614396,12333.845706,13301.259738,14092.407654,14744.865564,14801.799064,14163.460662,13500.982456,13242.276632,13153.915840,13254.346534,13489.823490,13551.083936,13396.680284,13224.741114,13058.039826,13059.178496,13375.728756,13740.786358,14011.789818,14099.239674,14029.325336,13734.637540,13262.772692,13069.198792,12956.470462,12845.564004,12992.680168,12913.656470,12646.296754,12511.933694,12259.832156,12128.201904,12206.542400,12265.753240,12266.891910,12134.806190,11935.766674,11627.414838,11332.271574,11164.203882,11030.751758,10939.658158,10823.513818,10716.934306,10555.698634,10375.105572,10191.551968,9927.152794,9767.283526,9586.918198,9335.499862,9221.405128,9080.437782,8791.898804,8579.422982,8301.815236,7934.480294,7688.072106,7376.987462,7056.793458,6926.757344,6724.757286,6322.579042,6115.341102,5879.864146,5748.689362,5639.604776,4547.620246,2635.565582,-35.981972,-3303.509404,-6348.996186,-8667.328306,-9968.828116,-10431.811338,-10426.345722,-10154.203592,-9660.020812,-8957.916890,-8246.020406,-7792.374278,-7656.417080,-8119.855770,-8887.091616,-10077.001766,-11407.651528,-12634.682320,-13986.055876,-14691.803542,-15667.188264,-15625.740676,-16231.057648,-14973.282766,-8434.811892,-7060.664936,-6482.220576,-2061.903636,-4069.378846,-8025.118426,-8100.042912,-8362.620214,-8818.771416,-7217.573662,-6292.518154,-7360.818348,-8248.980948,-9293.141338,-10679.130462,-10953.322198,-10161.263346,-9519.736668,-9087.269802,-8845.871762,-9194.760250,-9779.581162,-10137.806744,-10323.409954,-10453.673802,-10401.750450,-10508.329962,-11016.859984,-11530.172420,-11897.279628,-12188.095946,-12255.049742,-12025.038402,-11789.561446,-11686.625678,-11715.320162,-11954.213128,-12255.049742,-12484.833348,-12610.997984,-12680.684588,-12772.689124,-12892.704942,-13083.318300,-13285.090624,-13451.564178,-13524.666792,-13475.020780,-13424.691566,-13388.254126,-13395.541614,-13436.306000,-13479.575460,-13520.112112,-13470.693834,-13397.363486,-13376.867426,-13365.252992,-13369.124470,-13407.611516,-13411.027526,-13311.735502,-13182.838058,-13083.318300,-12946.905634,-12847.613610,-12810.265234,-12717.122028,-12640.147936,-12524.914532,-12294.219990,-12106.794908,-11960.589680,-11782.501692,-11656.109322,-11544.064194,-11375.313300,-11209.978416,-11012.533038,-10798.463078,-10575.056024,-10366.907148,-10187.680490,-9926.925060,-9714.904706,-9563.233862,-9334.588926,-9094.101822,-8912.370090,-8718.340722,-8411.127556,-8150.144392,-7954.748620,-7677.596342,-7405.226478,-7177.492478,-6965.927592,-6662.358170,-6373.591458,-6175.690612,-5845.248578,-5579.027532,-5388.641908,-5102.835738,-4865.081442,-4584.968622,-4263.408214,-4021.099238,-3698.627894,-3381.849900,-3223.119302,-2986.503676,-2729.391990,-2559.730160,-2373.443748,-2173.721030,-1970.354568,-1696.618300,-1477.993660,-1607.802040,-1216.099560,362.552528,2787.691894,6138.797704,9942.866440,13205.383724,15261.138542,16001.274042,15858.484824,15394.818400,14867.841924,14162.777460,13360.470578,12716.438826,12434.731868,12607.354240,13188.986876,14084.664698,15194.640214,16310.764548,17218.740006,17862.088556,18205.511428,18329.170990,18362.647888,18356.499070,18402.729072,18530.715580,18669.861054,18806.273720,18936.993036,19046.533090,19153.340336,19240.562458,19300.911968,19352.835320,19413.412564,19480.138626,19515.665130,19524.091288,19532.517446,19534.339318,19523.408086,19488.109316,19456.454290,19430.264880,19352.835320,19251.949158,19134.210680,18977.757422,18804.451848,18625.225190,18438.255576,18248.780888,18068.415560,17886.228360,17701.991554,17530.735586,17374.737796,17225.116558,17069.574236,16907.883096,16730.022842,16528.022784,16304.387996,16066.633700,15819.770044,15552.865796,15270.020168,14986.035870,14687.021128,14375.025548,14071.683860,13755.589068,13422.414226,13085.367906,12733.291142,12372.105018,12007.958352,11646.316760,11289.685316,10923.489044,10538.618584,10136.440340,9717.637514,9276.289022,8818.999150,8358.748736,7894.399110,7422.534262,6946.797936,6463.546388,5979.611638,5508.885460,5028.822188,4529.629260,4029.980864,3520.312172,2995.385302,2481.617398,1979.919396,1478.221394,979.028466,465.032828,-61.260446,-590.058794,-1119.995812,-1626.020760,-2106.994968,-2574.760604,-3020.891510,-3445.159952,-3865.556916,-4277.072254,-4678.795030,-5086.894358,-5501.825706,-5929.965626,-6372.908256,-6823.366108,-7279.289576,-7741.361862,-8199.562670,-8640.227960,-9073.605762,-9495.824598,-9893.675896,-10262.377242,-10599.195828,-10922.122640,-11242.999846,-11562.738382,-11893.180416,-12236.375554,-12579.570692,-12925.270904,-13275.298062,-13608.700638,-13924.567696,-14231.097660,-14528.290530,-14808.403350,-15065.970504,-15320.577116,-15564.707964,-15790.164624,-16016.076752,-16240.622476,-16458.336180,-16670.128800,-16875.544868"; 

vector<float> parse_voltage_data(const string& data_str) {
    vector<float> data;
    stringstream ss(data_str);
    string item;
    while (getline(ss, item, ',')) {
        data.push_back(stof(item));
    }
    return data;
}

// ==========================================
// Main Testbench
// ==========================================
int main() {
    cout << "Initializing PMU Testbench..." << endl;

    // Open output CSV file
    ofstream outfile("csim_results.csv");
    outfile << "Time,Raw,Mag,Angle,Freq,ROCOF,EstV,LSE,Trig,Gated" << endl;

    // 1. Initialize LUTs and Coeffs
    demod_t cos_lut[LUT_SIZE];
    demod_t sin_lut[LUT_SIZE];
    demod_t fir_coeffs[NUM_TAPS];
    adc_t raw_delay_line[GROUP_DELAY] = {0}; // Initialize delay line
    demod_t fir_buffer_real[NUM_TAPS] = {0};
    demod_t fir_buffer_imag[NUM_TAPS] = {0};

    generate_trig_luts(cos_lut, sin_lut);
    generate_fir_coeffs(fir_coeffs);

    // 2. Load Data
    vector<float> raw_input;
    ifstream infile("data/input_data.csv");
    if (infile.is_open()) {
        cout << "Loading input data from input_data.csv..." << endl;
        string line;
        while (getline(infile, line)) {
            if (!line.empty()) {
                raw_input.push_back(stof(line));
            }
        }
        infile.close();
    } else {
        cout << "Error: Could not open input_data.csv! Using hardcoded data (which may mismatch)." << endl;
        // Fallback to hardcoded if needed, or just exit/fail
        return 1;
    }
    cout << "Loaded " << raw_input.size() << " raw samples." << endl;

    // 3. Padding Logic (Reflection Padding)
    // padding = RAW_INPUT[-GROUP_DELAY:][::-1]
    int padding_len = GROUP_DELAY;
    vector<float> padding;
    if (raw_input.size() >= padding_len) {
        for (int i = 0; i < padding_len; i++) {
            padding.push_back(raw_input[raw_input.size() - 1 - i]); // Reverse last N
        }
    } else {
        // Fallback if input is too short (shouldn't happen)
        padding.resize(padding_len, 0.0f);
    }
    
    // Create Processing Input
    vector<float> processing_input = raw_input;
    processing_input.insert(processing_input.end(), padding.begin(), padding.end());
    
    // Scale Input Data handled inside simulation loop
    cout << "Scaling input data by factor: " << SCALE_ALPHA << " (inside loop)" << endl;

    cout << "Processing " << processing_input.size() << " samples (Raw + Padding)." << endl;

    // 3. Simulation Loop
    angle_t prev_angle = 0.0f;
    freq_t prev_freq = (freq_t)FN;
    int_t trigger_state = 0;
    data_t output[8];

    cout << "\nStarting Simulation..." << endl;
    cout << "Idx, Raw, Mag, Angle, Freq, ROCOF, EstV, LSE, Trig, Gated" << endl;

    int event_count = 0;

    for (size_t i = 0; i < processing_input.size(); i++) {
        // Scale input to match fixed-point dynamic range and thresholds
        // SCALE_ALPHA is defined in pmu_top.h (e.g. 20000.0)
        float raw_sample_unscaled = processing_input[i];
        const float scale_factor = (float)SCALE_ALPHA;
        float scaled_val = raw_sample_unscaled / scale_factor;
        adc_t raw_sample = (adc_t)scaled_val;
        
        pmu_top(
            raw_sample,
            (int_t)i,
            cos_lut,
            sin_lut,
            fir_coeffs,
            fir_buffer_real,
            fir_buffer_imag,
            raw_delay_line,
            prev_angle,
            prev_freq,
            trigger_state,
            output
        );

        // Update state variables
        prev_angle = (angle_t)output[1];
        prev_freq = (freq_t)output[2];
        trigger_state = (int_t)output[6];

        // Count events only for valid aligned indices
        // aligned_index = i - GROUP_DELAY
        int aligned_index = (int)i - GROUP_DELAY;
        
        if (aligned_index >= 0 && aligned_index < raw_input.size()) {
            data_t aligned_raw = raw_input[aligned_index];

            // Write to CSV file
            if (outfile.is_open()) {
                outfile << aligned_index << ","
                        << aligned_raw << ","
                        << (float)output[0] * 2.0f * SCALE_ALPHA << "," // Mag
                        << (float)output[1] << "," // Angle
                        << (float)output[2] << "," // Freq
                        << (float)output[3] * SCALE_ALPHA << "," // ROCOF
                        << (float)output[4] * SCALE_ALPHA << "," // EstV
                        << (float)output[5] * SCALE_ALPHA * SCALE_ALPHA << "," // LSE
                        << (float)output[6] << "," // Trigger
                        << (float)output[7] * SCALE_ALPHA << endl; // Gated
            }

            if ((float)output[6] == 1.0f) {
                 event_count++;
            }
            
            // Print sparse samples to console for progress monitoring
            if (aligned_index % 100 == 0 || (float)output[6] == 1.0f) {
                 cout << aligned_index << ", " 
                      << aligned_raw << ", "
                      << (float)output[0] * 2.0f * SCALE_ALPHA << ", " 
                      << (float)output[1] << ", "
                      << (float)output[2] << ", "
                      << (float)output[3] * SCALE_ALPHA << ", " 
                      << (float)output[4] * SCALE_ALPHA << ", " 
                      << (float)output[5] * SCALE_ALPHA * SCALE_ALPHA << ", " 
                      << (float)output[6] << ", "
                      << (float)output[7] * SCALE_ALPHA << endl; 
            }
        }
    }

    cout << "\nSimulation Complete." << endl;
    cout << "Total Trigger Events (Samples): " << event_count << endl;

    if (outfile.is_open()) outfile.close();
    return 0;
}
